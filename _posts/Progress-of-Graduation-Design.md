---
title: 毕业设计记录
date: 2016-12-27 10:13:48
tags: [Frontend, Diary]
---

### 2016/12/27

今天是第一天正式开始做，目前分配的目标是平台搭建。// 考研终于结束了……

我做的是微信客户端（其实我猜应该是公众号吧，不然没有小程序的权限啊），那么任务可明确为“移动设备 HTML5 应用开发”，初期的平台搭建任务实际上是 Web 服务端搭建。按理说微信公众号的申请也算是平台搭建的任务，但我已经有自己的微信公众号了，所以就不在这里说明公众号的申请的细节了（都快要三年过去了呢）。此外，我也有自己的 VPS，因此服务器购买也不算在这里。

要做的事情就是搭建 Web 服务器了。

关于服务器选择问题，由于之前有搭建 nginx 的经历，此处就直接采用 nginx 了。

而关于动态语言的选择问题，我只会一点 PHP……虽然以前也在一些 Python / Django 的项目里挑过 bug，不过还是不太敢自己写新的项目用（不过 Python 用起来确实比较舒服，起码不容易小指骨折）

具体过程如下：

1. 登录到 VPS 上，看看源里有没有现成的程序可以用

 源里是有 nginx 和 OpenSSL 这样的程序，但 VPS 的系统是 CentOS 6, 源用的是 EPEL，其中 OpenSSL 的版本是 1.0.1e-fips，而 OpenSSL 官方网站上带 -fips 的版本是 2.0了。故选择自己编译 OpenSSL，同时 nginx 也要一起重新编译。（源里面的 nginx 是 1.10.2, 是最新的稳定版，这比前一个 VPS 的源里的版本新的多了，不知道前面那个 VPS 自带的上游源没有同步，我当时也懒得换源）

2. 下载相应的源码，按依赖顺序编译

 这很简单，去官网找到链接，复制到 shell 里面用 wget 就好了。这里选择的是 nginx 1.10.2, OpenSSL 1.0.2j，PHP 7.1.0. 分别 `tar xf` 解开，按 OpenSSL -> nginx -> PHP 的顺序编译就好。`configure` 参数命令行如下所示：

```
# OpenSSL
./config --prefix=/root/root --prefix=/root/root/ssl

# nginx
./configure --prefix=/root/root --with-openssl=/root/src/openssl-1.0.2j

# PHP
./configure --with-openssl=/root/root/ssl --enable-mbstring --enable-fpm --prefix=/root/root --with-mysqli --with-pdo-mysql --with-gd
```

 每个 `configure` 结束以后用 `make install` 来安装到 /root/root 目录下，以避免污染系统自带的版本。库的版本不能随便乱动的，免得整个系统崩掉，更何况 OpenSSL 的 branch 都变了。要体验完全源码编译的乐趣的话，像 Gentoo 那样自动编译整个系统比较好……

 顺便吐个槽，PHP 的 `--with-openssl` 的帮助就只说了一个 Include OpenSSL support (requires OpenSSL >= 1.0.1)，谁知道它到底要的是 OpenSSL 的安装路径还是源码路径？还是 nginx 做得好，set path to OpenSSL library sources. 蛋疼的是，PHP 要求的路径是安装路径，与 nginx 相反……

 （为什么 Sublime Text 下载得这么慢啊）

3. 测试 nginx

 直接打 IP 进去，提示 403. 看起来是 nginx 默认自己降到 nobody 用户。为了方便管理，给它新增一个 nginx 专用账户。

```
groupadd nginx
useradd -g nginx nginx
chsh -s /sbin/nologin nginx
```

 最后一行是防止这个账户通过 shell 登录。（在 `useradd` 里面加两个参数就能用一条命令做完三条的事，不过我不记得了……）

 然后把 nginx 的 html 文件夹移动到 ~nginx/ 底下，`chown` 一下，403 就没有了。

4. 配置 & 测试 PHP

 这里有些麻烦。先是尝试了几次才找对全部需要的参数（如上命令行，`--enable-fpm` 和扩展相关的参数一开始就没加，得到的是裸的 PHP），然后复制 php-fpm.conf.default 把 .default 去掉，设置 socket 路径，改启动用户为 nginx，启动后手动 chown nginx:nginx 它的 socket 文件。nginx 有自带 PHP-FPM 的配置，一行 `include fastcgi.conf` 就好了。

 要特别注意的是 nginx 的 fastcgi_temp 目录需要指定到 nginx 能够写入的位置，我这里 nginx 的程序放在 ~root 下面，所以它默认的 temp 目录也在这下面。需要用 `fastcgi_temp_path` 指定到 ~nginx 底下去然后 chown，否则能返回 HTTP 200 但 php 网页显示不全。

 至于 PHP 的探针，`phpinfo();` 就足够了～

5. 微信推送测试

 由于公众号权限不足，故只能通过回复消息的形式给出链接，菜单功能只能稍后处理。回复消息包含的链接文本会自动转化成可点击的链接。


### 2016/12/28

今天主要的任务是写一个 Demo. 打算先实现简单的登录功能，然后显示点简单的数据，比如显示目前登录到的变电站名称，目前该站拥有的设备及其最近一次故障记录详情。自己的测试服务端里要写死以上数据。

任务书还没下来，不知道要做微信登录还是用户名密码登录。微信登录个人感觉不是很必要，因为我们这里并不强调人与人的关系。所以，这个 Demo 还是按用户名和密码做。

此外有一点要注意的地方，就是这里面涉及的数据都比较私密，所以前端发送密码时应该加盐 hash 一下，并且做到每次发送的字符串都不一样。但是查了一下关于这个问题的讨论 [1]，发现还是有不少人认为只要有 HTTP 连接就没有加密的意义了，即便是一次一密，也能通过前端页面公开的算法甚至 XSS 做中间人攻击。但是我觉得如果服务器真的是在登录的时候发来 nonce，那么即便是监听到了也很难通过 hash 反推密码啊。一个 nonce 怎么也要十几个字符了，加用户名加密码得有二三十个字节长，用 bcrypt 之类的怎么反推得了……（当然 HTTPS 是最好了，但目前要上 HTTPS 的话要通过 CloudFlare，速度会很慢）

[1] https://www.zhihu.com/question/25539382

做的时候发现 Javascript 里似乎没有现成的散列函数，选择用 SHA256 [2] 好了。

[2] http://www.bichlmeier.info/sha256.js

PHP 是被访问时执行一次然后退出，以前以为是必须要把当前会话的状态存入数据库的，现在查到 PHP 自身支持 session 功能，不需要数据库也可以在不同的访问中保留状态。

（发现 PHP 已经忘得一干二净了）

（为什么 PHP 在使用全局变量的时候还要先用 `global` 啊）

HTML 从头开始写的话有点懵，最后从 MDN 找了 AJAX 请求代码修改了下来验证 SHA256 函数以及登录过程实现正确。最后是验证成功了，今天就到这里了，代码已经 push 到 GitHub 了，有心情再回去看吧。

（说起来，总觉得 PHP 里面的那些类实现得很奇怪，突然不知道类里应该要写哪些方法了……）

### 2016/12/29

今天要汇报了，想着给那个测试登录用的网页加点样式吧。不过这次时间有点赶，看书可能来不及，先口胡两句 CSS 上去……

CSS 水平居中好说，垂直居中的话如果用父元素 table、子元素 table-cell 的方法，要记得在 html {} 里就把 `height: 100%` 写好，否则后面 inherit 来的高度最大也就只有那么大了，不能覆盖全屏。

剩下的都慢慢调……不知道为什么 `position: absolute; left: 0; right: 0;` 的 copyright notice居然没有跟登录框水平对齐，明明登录框已经是 `text-align: center` 了。好像是登录框歪了，不知道为什么……暂时把 left 改成 2%，看起来舒服一点。

闪烁背景提示错误的功能用 CSS Animation 比较好实现。如果要在 JS 里触发动画，只要在对象的 style 属性里把 `animationName` （对应 CSS 里面的 `animation-name` 属性，style 里面的成员都是这样）设为空，然后用 `setTimeout(function(){}，0)` 把 `animationName` 设为动画名称就好了。至于动画时长、重复次数之类，都应该直接在 CSS 里面写好。

TODO 刚才想到，我在登录那里用了 nonce 和两次 SHA256，就是为了防止被窃听。但窃听还是能够拿到 PHPSESSID 啊，有了这个也一样能登录了。但是，考虑到这是微信端，用户 IP 随时可能变化，不能通过绑定 session 和用户 IP 的方式来做验证，而其他任何不是客户端固有的数据都能够通过窃听获取到，所以防登录是没有办法了。这样 hash 就只能是防撞库和明文密码泄漏……

顺便，Android 为什么比 iOS 好呢？因为它可以设定 `theme-color` 这个属性啊，比 iOS 除了白还是白的顶部不知道高到哪里去了。

### 2016/12/30

听说今天是最后一个工作日了呢……今天上午学长介绍了下本地网络的情况，需要加上无线接入功能，使得笔记本和手机能够通过无线读取数据，并且模拟某电厂内部的情况——WiFi只能够上内网。

我理解的本地网络是这样构造的：

有一台非网管交换机接入上游教育网，下面接正向和反向网络隔离设备，往下接另一个非网管交换机，再往下接各台服务器。内网没有 DHCP 和 DNS 服务，所有服务器都是手动配置的 192.168 开头的私有地址。昨晚还提到一个需求：做出来的移动端在公网和内网都要能用。

说起来不知道网络隔离设备是做什么的。我电脑插在直连公网的交换机上，但是直接配置 192.168 的地址是可以访问内网的，也不需要校园网认证（相当于我可以从上游访问）。但是根据学长的描述，隔壁实验室同是公网，配置 192.168 不能够访问这里。为什么同是公网却不能访问呢，是什么设备起了阻隔作用呢？我现在的一种推测是，其实网络隔离设备并没有起作用，实际上是因为我这里的上游交换机和隔壁实验室的上游交换机没有连到同一个路由器（至少不是同一个 VLAN），192.168 无法跨越。另一种推测是其实在隔壁是能够访问的，但因为要跨越上游交换机（而不是路由器），所以要通过认证来开启端口；但要做认证的话，锐捷又会分配公网 IP。这样一来，不过认证直接配 IP 会导致交换机端口不开，不通，过认证了又配不了 IP……TODO 我找个时间找认识的学长用 minieap 测试一下开认证 + 手动 IP 吧。万恶的锐捷。

（2017/01/04 回顾：实际上只能访问分给我的那台服务器。因为那台服务器跟我一样被接到公网但还是配置着 192.168 的内网 IP，所以我以为能访问整个 192.168 ……内网其他服务器是不能访问的，隔离设备实际上生效了）

好了，回到原始话题。网络结构说完了，接下来是网络里的数据流。

首先，有准实时查询功能：（个人理解）浏览器客户端每隔 10s 从服务器请求一次数据，现场客户端每隔 1s 上报一次数据。既然是定时的，那就不会是长连接，应该也不是 UDP，所以能够无压力跨越 NAT。

其次，有分析结果广播功能：（个人理解 x2）因为数据量比较大，在浏览器客户端分析计算会比较麻烦，所以后台会先分析一部分。在分析完成的时候，服务器会发送 UDP 广播来通知其他服务器，这个当然跨不了 NAT。不过，接入 WiFi 的设备不需要接收这个（要的话也不难啊，路由改 AP 就是了）

还有一种用客户端发起 TCP 连接的功能，不是很记得（历史数据查询？），也是查询类的，可以跨 NAT。

综上所述，WiFi 端可以采用静态 IP + NAT 这种最简单的配置方式，几乎什么路由都能满足。备选方案是路由改 AP，找一台服务器做 DHCP 和 DNS。这样也是什么路由都能满足的。

（说起来，昨晚提到的那个移动端内外网都能用的问题，可以靠内网 DNS 单独配置来解决。这样一来，无论如何都要在内网配置 DNS 了，不然给路由刷个改版固件吗……）

敲定了路由没有特殊要求以后，接下来是无线环境要求。

首先，用户量在 20 人。最大数据量是 20 人同时查询一天内的详细数据：一条数据是一个浮点值（假设是 8 bytes 的原始形式），每隔 1s 有一个，一天有 86400 * 8B = 691.2KB，20 人就是 691.2KB * 20 = 13.824MB。假设服务器在 1s 内能够查询完毕（我记得学长提到了上报时先写缓存，不知道查询时有没有缓存），考虑其他开销，取最高速度要求为 20MB/s 应该是足够了。

那么问题就是 20 人，总速度 20MB/s，覆盖面积是机柜附近，大约 30 平方米。有线千兆没得跑。预算……不好说，要是学长直接说不限价格的话，直接买 UBNT 啊。但是，并没有这么说……

（搞不好还是 20 个 2.4GHz 设备……家用路由真的撑得住？）

想了想，还是用 Netgear R6220 好了。（JD 没有 Newifi D1, 不然用它的话内网可以省一个 DNS）

好了，关于我自己的这方面，我想先写一个获取一个变电站最近数据的页面，把这个 AJAX 弄好。可以开始看书了。

TODO 现在有这么多 XHR 请求了，应该要做一个 XMLHttpRequest 池。不过是不是应该引入框架呢？如果后面还有人要维护这些代码的话，还是赶紧学学框架吧。

### 2016/12/30 - 2017/01/03

Happy new year!

元旦假期，这几天主要是在做别的服务器维护工作。被 Intel 的 FakeRAID 和 Seafile 坑了……

关于这几天的 JavaScript（细节）：

1. 1 == true, 1 !== true ((1 === true) is false)
2. 在函数里面用 `var` 可以声明一个局部变量（从而遮蔽掉同名的全局变量，不会导致错误）而在没有 `var` 也没有同名全局变量的情况下，会（在函数里面）创建一个别处能用的全局变量……
3. DOM 里面的节点有元素节点、文本节点和属性节点三种
   根据 W3Schools，child nodes 只包括文本、注释和元素节点。属性节点在 attributes 里面，且用NamedNodeMap 表示，而不是其他节点一样是 HTMLElement. 比如 `<h1 id="header">text</h1>` 里面的 text 是文本节点，要通过 `h1.firstChild` 来访问。id 属性节点要用 `h1.attributes` 访问，也可以用 `[get|set]Attribute(name[, value])`。
   要改变包含文本的内容，就要先找到外面的元素节点，然后 firstChild 得到文本节点，在上面用 nodeValue 改。
4. 三大经典方法 (HTMLElement.)getElementById, getElementsByTagName, getElementsByClassName.
   注意最后一个是 HTML5 加的，它在传入 "btn-close custom-btn" 这样的参数时，选择的是 **同时** 具有这两个 class 的元素，而非选择两个 class 各自的所有元素。getElementsByTagName 可以用 "*"做参数来取出所有节点。这两个都返回数组，记得 [0]！
5. HTML-DOM 说可以用 `image.src` 来修改 <img> 的 src 属性，而 DOM Core 说要用 `image.setAttribute('src', ...)`。前者可以在 HTML 里运行，后者可以通用于任何使用 DOM API 的标记语言。
6. JavaScript 的 event handler 在返回 false 的时候会停止继续冒泡（即可以阻断默认行为）。在 handler 里面用 `this` 可以取得引发事件的元素。
7. nodeType 里的 2（Node.ATTRIBUTE_NODE）在 DOM4 里已经被 deprecate 了
8. 平稳退化：假设 JavaScript 没有被浏览器支持或者被禁用，则网页的基本功能仍然需要保持正常（比如该在本页打开的在 href 也写一遍，就可以在 JS 关闭后仍能在新窗打开）特别注意在拦截 event 的时候，如果拦截下来了但操作失败，千万记得 `return true;` 让事件继续传递。
9. 渐进增强：（平稳退化 Plus）在 HTML 以外增加一层 JavaScript 而无需对 HTML 做太多修改（至少是不要在 HTML 标签里面写 onclick 了），像 CSS 一样 hook 上去生效。可以在 JS 里用 `onload` 和 `element.onclick` 之类的方法动态“hook”上去。要注意在 getElementById 的时候要检查是不是 null！
10. JS 文件里直接暴露在最外层的代码（不在函数里的）在 JS 文件加载时就会执行，所以要用 onload 延迟一下。
11. 减少请求数量是优化加载时间的首要问题（？）
12. 浏览器兼容最好用 `if (!window.XMLHttpRequest) return false;` 这样来做，不然缩进层级太多
13. Accessbility: `onclick` 也会在按下键盘回车的时候触发，所以不需要再处理 `onkeypress` （这名字一听就坑）
14. `document.createElement()` `document.createTextNode()`
15. XMLHttpRequest 的属性里有一个 responseXML，是把 responseText 处理成 DOM 树的结果（所以它叫 XMLHttpRequest）
16. Ajax 的同源策略！而且 Ajax 要特别注意平稳退化，比如登录的时候应该按先 POST 整个页面然后显示结果页面的方式做，然后在 JS 里 hook 掉 onsubmit 来做 Ajax 动态刷新，这样就可以平稳退化了。
   但是，对于我这里做的这个网站，我觉得是没有必要做到这么激进。首先，微信浏览器虽然辣鸡，但怎么着也是支持 JS 的。其次，后面页面要求 1s 刷新一次，要是全页面刷新的话流量要飞起来了，持续的 loading 白屏也很影响正常使用，所以 JS 是肯定要有的，无法妥协。没有 JS 的话直接拒绝服务吧。
17. `HTMLElement.style` 属性只能用于内联的样式，外部 CSS 文件的读取不到。但是从 DOM 写入 style 的样式可以再被读出来。（BTW CSS 转 JS 的驼峰命名法）

归纳起来就是：

* JavaScript 的设计思路：检查可用，层次分离；平稳退化，渐进增强
* DOM 的操作方法：三种元素的增删改查

几个问题：

* 书上的示例中，需要 JavaScript 来改变的部分都是不写入 HTML 的，而是由 JavaScript 动态添加。比如图片库例子里的 placeholder <img> 以及 Ajax 结果的 <p>。这在此元素仅用于 JS 的时候是没问题的，但所有元素都动态创建是不是太麻烦了？尤其是 Ajax 结果，它难道不是本来就应该在那里，然后由 JS 来改变的吗？
* `setTimeout()` 的第一个参数难道不是直接传入函数的吗，为什么书上是传入字符串……
  查了 MDN，说是传代码字符串就像 `eval()` 一样不建议使用了。

晚上开会讨论了下需求，发现现有的后台基本都把接口留好了，问了下学长也有接口文档，那应该不是很麻烦了。具体的可以看另一篇文档。

### 2017/01/04

买的路由器到了，把它接在公网交换机上，配置 192.168 的固定 IP，访问分给我的服务器毫无压力，但内网其他服务器不可以。后来发现是因为分的服务器也在公网上（我记得第一次看到它的时候它上面啥都没插）但还配置着固定 IP，所以路由器接公网配置固定 IP 访问它毫无压力。要访问内网的话，如果要接到内网交换机，双线不可避、刷机不可避。

我先在自己的那台 R6220 上试了下，新建一个 VLAN，新建一个 WAN 接口，设置成静态地址，插上连接到内网交换机的网线，可得到内网 + 公网访问。看起来应该是需要的了。

更新：需求更改，不需要做内网访问。

更新后的网络规划如下：

为了能够进行微信推送，分给我的服务器需要能够访问外网（推送到手机），并能够被外网访问（接受手机上行消息的推送）。因此，这台服务器将运行校园网认证，并配置路由服务。

其次，由于校园网认证是二层操作，最好将其配置在单独的网卡上，以免对内网数据产生干扰。但服务器上只插了一根网线，故使用 macvlan 划分为两个虚拟网卡，主网卡用来认证，副网卡配置内网。

```
ip link add link eth0 name macv1 type macvlan
ip link set macv1 up
ip addr add SERVER_INTERNAL_ADDRESS dev macv1
```

下面来编译（主要是自己写的）校园网认证客户端。

顺便注明为什么不用锐捷官方客户端：

* 锐捷会把 NetworkManager 服务器停掉，导致网络难以配置
* 锐捷可能会检测虚拟网卡之类并拒绝认证，对认证造成影响

虽然本校客户端已经尽力去除了它的流氓行为（以上第二条），但还是要记得锐捷是一家很恶心的公司。不要用技术无罪来开脱。

由于这个时候还没有外网访问，因此把 minieap 的源码用 tar 打包，scp 传上去。注意在 config.mk 里面添加自定义 CFLAGS `-std=gnu99`，因为服务器上的编译器太老了，是 gcc 4.4.7，默认不支持源码里的某些写法。

然后启动认证的命令就很简单：

```
minieap -u USERNAME -p PASSWORD -a 1 -d 2 -b 3 --module rjv3 --heartbeat 30 -w
```

要注意 `--heartbeat 30`，因为宿舍区用 60 就可以了，所以第一次用的时候总是 45 秒掉线，后来才发现是这里的问题。其他参数可参阅软件内置帮助。

在 NetworkManager 里面把 eth0 改为 DHCP，就可以看到公网地址出现了。

下面来配置 IPv4 NAT。由于客户端电脑连接这个网络的时候就不能再连接其他网络（只有一个网卡）所以这个网络虽然不要求公网访问，但也最好要配置到能上公网，否则不便于查资料。

先打开 IPv4 转发。

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```

方便起见在 /etc/sysctl.conf 中把 net.ipv4.ip_forward 也改为 1.

再设置 NAT

```
iptables -t nat -A POSTROUTING -s R6220_WAN_ADDRESS/32 -j MASQUERADE
```

注意这里 -s 是具体的 IP 地址，而不是一个段。这样限制本服务器只能 NAT R6220 过来的流量，而不能为其他内网设备提供公网访问。

最后配置防火墙，禁止此服务器转发其他流量（比如从公网过来访问内网其他设备的）

```
iptables -P FORWARD DROP # 不符合以下规则的转发数据包全部禁止
iptables -A FORWARD -d R6220_WAN_ADDRESS -j ACCEPT # 允许转发到 R6220
iptables -A FORWARD -s R6220_WAN_ADDRESS -j ACCEPT # 允许转发来自 R6220 的数据包
```

我看了一下，R6220 上没有 IPv6 穿透的设置，实在是太可惜了，不然可以同时再配置一个 Google 和 Wikipedia 直连。服务器这里也不再配置 IPv6 了。

R6220 的 WAN 地址固定，网关设置为 SERVER_INTERNAL_ADDRESS 即可。

晚上，学长讲解了快速组态查询从点击到返回数据的流程。我发现后台有一个接口可以直接调用，学长也讲解了数据库的结构，根据这里来做就好了。详细的接口文档请出门右拐看专门的文件。

### 2017/01/05

早上来了，启动服务器上的 minieap，咦，还是没网？一看 dmesg，segfault 了。`ifconfig` 发现所用的网卡又被 NetworkManager 变成固定 IP 了。想起来昨天第一次用 `-d 1` 的时候也是会 segfault，那时候也是固定 IP，看来只要网卡是固定 IP 而认证时 DHCP 开启就会 segfault。（错误发生在 libc 里面，暂时不太想去改，先把网页写好再说吧。）

于是为了避免 NetworkManager 瞎搞，再划分一个新的 macvlan，在这个新接口上认证就好了。RHEL 6.4 上的 NetworkManager 不支持配置 macvlan 这种虚拟接口，正好。

```
ip link add link eth0 name macv2 type macvlan
ip link set macv2 up
dhclient -4 macv2
```

那么今天要做的就是根据昨晚说到的接口实现界面。

P.S. 学长说可以把现有的网页的代码粘贴下来，但是那些代码中数据处理逻辑和界面耦合得太紧密了（此外缩进感人），我这里不方便用……感觉还是自己写吧。

上午都拿来写接口文档了，下午也花了一点时间来写，现在取得快速概览数据所需要的几个接口都已经有文档了，可以开始写脚本了。

下午还写了一个 AJAX 库。暂时不太想引入 jQuery，不知道是为什么……

晚上开始写界面啦。

注意一点，div 的 border 要专门指定 `border-style` 才会显示出来，不然怎么调 width 都看不见。

问题：如何在 table 的每一行中间显示分割线？

答：table 元素的 rules 属性设置为 none 来禁止显示分割线（禁止占地方），把 tr 高度设为固定需要的值，设置 td 的 border-bottom 即可。这是 tr 高度能够固定的情况。

字体大小还是要慢慢调……

### 2017/01/06

上午主要是做文档工作，记录下从连接校园网到配置域名解析网络配置流程。下午有博士答辩，感觉去了会碍事，还是不去好了（但是队友说要去啊那就去吧）

下午来填充 JS 内容吧，今天希望能把这个页面的功能完成……

说到这里，我有一个疑问：既然每个服务器上的 web 界面都不一样，那么我最后要交的就是使用这台 web 服务器的作品吗？虽然各个变量看起来确实是跟发电机有关的（定转子 etc）但是这不是第一次给我们看的那个界面啊……不过反正表格布局、数据解析和 ajax 都有了，即使要重新做也应该很简单。

（结果下午博士论文答辩，我要去东边回不来，所以下午就没有去，在周末补了一点 JS）

### 2017/01/09

来写 JS 了。macOS 的全屏模式真好用，以后带鼠标用 macOS，不用 Debian 了。不想去折腾那下面的 Sublime Text……

JS 的 `for (var x in ...)` 是遍历属性用的，不是遍历数组（不然它会遍历出数组的属性）。要遍历数组还是用 `myarray.forEach` 好了。

`myarray.includes()` 的参数必须要是数组的内容，而不能是数组的下标。如果要查找下标是否定义，可以用 `if (key in myarray)`

正反向隔离的文件传输客户端会有问题，外网端获取数据内网要过很久才会回应，甚至直接超时，返回空数据，导致 API 挂掉。学姐看了以后说是反向端临时文件没有删掉，造成效率急剧降低。这个问题交给学长了。

后来这个问题修好了，但还是很慢……

为什么 onblur 是失去焦点时执行的……blur 这个词挺文艺啊。

在 Chrome 里要让 `<select>` 里面显示的已选择项靠右对齐，可以用 `text-align-last: right;`，但 Safari 不支持。

Chrome 里可以用 select 的 onclick 方法来做点击重试，而微信浏览器不行。看来还是弄个 span 好了。

多选框在 PC 端显示为多行，手机端显示为单行（“选择了 n 项”），手机端比较好看。

disabled 不需要加值，只要有个 disabled 在 tag 里面就会起作用。并且 CSS 里面可以用 `select[disabled]` 这样来设置禁止的样式，不需要专门弄个 class。

今天只是写了一些样式，做完了逐步加载参数选择的功能而已……

### 2017/01/10

今天是个值得纪念的日子，因为可以正确地画出图表了！

前几天一直在纠结用什么图表库，一开始看的是 CanvasJS，因为它的触摸手势缩放功能很好用（是单指拖动标记要放大的区域，像鼠标一样，很精准）。后来一看，免费试用 30 天，收费吓人，于是放弃。

后来看到 Dygraphs，手势缩放是自然的双指捏合缩放，而且免费。但是它的手势缩放太快了，经常不知道缩放到哪里去了……

最后想起来 Highcharts，目前的 PC 端也是用的这个，我去看了下居然对个人用户免费。那很好啊，而且这么有名的库，功能应该不会差吧？试了下，也是双指捏合，但增益没有 Dygraphs 那么夸张，用起来也还不错，那么就选它了。

然后就是看看 API 文档，初始化参数，然后根据返回的数据添加轴和系列。不要直接操作 chart.axis 属性，而是要通过 chart.addAxis。要注意一点，`addAxis` 和 `addSeries` 的第一个参数是 `options`，要传入的是类似于初始化函数里面的那种对象， **但是** 不要带 `{'series':{...}}` 这样的包装！直接传入 `{'name':'My Series', 'data': [[1 1], [2 4]]}` 就好了。被这个坑了一个多小时，数据都加上了，断点看传过来的数据都是对的，甚至还以为是不能直接支持 Date 做 X 轴，尝试了很多时间格式，结果图上都是空的……最后才发现是 addSeries 的参数不对，那个对象我是直接写在 addSeries 的函数调用里面的（`chart.addSeries({'series':{'name':name, 'data':data}}, true)`），所以断点看不到它的结构，也就没有往这里想。

还有一点就是用日期做 X 轴的时候，series 里面的 X 轴坐标是 Unix epoch 到目前的毫秒数，而不能直接用 Date object，否则画出来的数据点横坐标是 1970/01/01 00:00:00.001，1970/01/01 00:00:00.002 这样子……

好的，那么这个历史数据查询就剩下一些 CSS 工作了，还有一些显示 / 隐藏 loading wheel 和 div 的事情，这些相比画图要简单多了。

P.S. 随手记一下，今天支付宝爆出登录密码修改验证过于简单，导致熟人可以修改自己的密码的问题。具体是因为允许了在非常用设备上使用“最近购买的物品”“常用快递地址”“选择好友头像”“连接过的 Wi-Fi 名”这样的问题来验证身份。讲真，这不需要是熟人（关系好的），只需要天天能见面就可以了……我把余额宝和余额都转进银行卡了，然后挂失，吃个饭回来支付宝说升级了，以后那些措施只能在自己手机上用，于是又把钱转回去了……（感觉好奇妙）

### 2017/01/11

程序员节？

今天是要给图表加样式，图表出现了以后隐藏选单，然后给个返回按钮退回选单。没什么好记的，慢慢调吧……

嗯……还是有要记的：`display: none` 不能触发动画效果，毕竟变化太大已经不能算是 transition 了。找了一下，比较好的做法是给 `max-height: 0; overflow: hidden` 加动画，然后视情况决定要不要 `display: none` 掉。要的话，可以在 `addEventListener('transitionend', ...)` 里面操作。

### 2017/02/13

万万没想到程序员节的记录后面就要到情人节的记录了啊啊啊啊啊！当然我不过情人节。

然后是迟到的新年快乐啊~寒假又长胖了一公斤，害怕。

在家里做的工作主要是翻译，13 页的英文，还有很多图和表。本来以为可以很快翻译完的，结果翻译到中文还是有 1W 字了，看了备份记录，10 天才翻译完……在火车上两个小时肝完了最后 1.5k 到 2k 字，发现在家效率真低，一小时才 0.7k 字左右，不然五天就翻译完了。顺便一提，Markdown 用于论文除了公式以外的部分都挺舒服的，直觉的加粗和分级标题方式不知道比 Word 高到哪里去了，并且 [Typora](https://typora.io/) 也不知道比 Word 流畅到哪去了，还能带图片实时渲染，光标移走以后自动隐藏格式符，66666. 唯一的问题就是搜索的时候从搜索框点到文本区域，光标可能会跳走，需要重新点击搜出来的位置……

在代码方面，看完了 JS 与 DOM 的入门书，对平稳退化与渐进增强有很深的印象。还有一本响应式设计实践，看了一大半，主要记得的东西是要合理安置 HTML 文件中元素的先后顺序，这样即使 CSS 不控制位置和大小，过大的元素也能被浏览器直接排到下一行显示，即不依赖 CSS 实现“响应式”。当然这只是极端的 backup，只是说要遵循这一点来写网页罢了。

回到学校以后，开了次组会（同学迟到被挂了），更新了一点要求，可出门右转查看。然后把相关的服务器全部开起来，根据以前的文章把校园网认证啊 NAT 啊啥的都运行了，然后写了篇综合的 Boot Sequence 介绍，以后可以直接抄里面的命令了。BTW 算是见识了服务器开机有多么吵，开机瞬间风扇开始全速转，转个 5 秒 8 秒的讲真耳朵要爆炸，还好不是两台服务器一起开……服务器启动的流程也是长，BIOS 要等个一分多钟，看到 Scanning devices 都要等好久，比较有趣，有机会买 Gen 8 玩 #(滑稽)。

剩下的时间是把 Markdown 转换成 Word。我怀疑我用的是假 Word，要么是 macOS 上的 Word 有 bug, 因为我在做分级序号的时候它硬是不能找出自己的第一等级编号是多少。也就是说，大刚显示“2. CMFD 概念”下的段落，设置分级序号以后是从 1.1 开始的…… 原因未知。并且，本来在一级标题以后二级序号要自动重置的，这里也没有重置，即一级标题“2. CMFD 概念”以下有 1.1, 1.2, 1.3，而一级标题"3. CMFD 实践"下有 1.3, 1.4, 1.5. 简直丧心病狂。手动在每个一级标题下重置了序号，然后把“2. CMFD 概念”下的二级序号依次删掉，手动改成，结果改完了 2.1 和 2.2 以后 2.3 以及其后所有的二级序号突然都自动更正了，能读到自己所在的一级标题序号了，迷。

今天还开了一大堆 ticket，比如 SS 某线路 80% 丢包但一旦通了延迟就很低，再比如 Logitech Options 跟 macOS 的安全键盘输入不兼容导致滚轮失效。如果上午服务器没开导致半个上午没网然后叫学长来解决也算的话，那也是个 ticket……

最后，准备加实时数据显示了，把已有网站的 Flash 弄下来反编译，发现跨域安全策略服务器和实时数据推送服务器都没开机。尴尬。明天再去开这个 ticket 吧。

（总部好像也需要搞个 Boot Sequence 文档，不然没人能接我这一届的盘了）

### 2017/02/14

真的到情人节了诶，然而我还是要在这里写文档 23333

今天先把文字部分在 Word 里的格式排好，然后把图表抠出来翻译。还好 Science Direct 上可以下载到原图，表格也很方便复制，花时间做就是了。

结果两小时过去了全都在写其他的文档 [doge].